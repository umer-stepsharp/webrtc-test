<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Basic WebRTC Test</title>
</head>
<body>
  <h2>Basic WebRTC Test</h2>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
  <p id="status">Status: Disconnected</p>
  <div id="log"></div>

  <script type="module">
    import { SmallWebRTCTransport, SmallWebRTCConnection } from "https://cdn.jsdelivr.net/npm/@pipecat-ai/client/+esm";

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusDiv = document.getElementById("status");
    const logDiv = document.getElementById("log");

    let transport = null;
    let connection = null;

    function log(msg) {
      logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
      console.log(msg);
    }

    startBtn.onclick = async () => {
      try {
        log("Connecting...");
        statusDiv.textContent = "Status: Connecting...";
        startBtn.disabled = true;

        connection = new SmallWebRTCConnection("ws://localhost:8080/ws");
        transport = new SmallWebRTCTransport(connection);

        connection.addEventListener('open', () => log("WebSocket opened"));
        connection.addEventListener('close', () => {
          log("WebSocket closed");
          statusDiv.textContent = "Status: Disconnected";
          startBtn.disabled = false;
          stopBtn.disabled = true;
        });
        connection.addEventListener('error', (e) => log("WebSocket error"));

        await transport.start();

        log("Connected! Speak into your mic.");
        statusDiv.textContent = "Status: Connected";
        stopBtn.disabled = false;

      } catch (error) {
        log("Error: " + error.message);
        statusDiv.textContent = "Status: Error";
        startBtn.disabled = false;
      }
    };

    stopBtn.onclick = async () => {
      log("Stopping...");
      if (transport) await transport.stop();
      if (connection) connection.close();
      transport = null;
      connection = null;
      log("Stopped");
      statusDiv.textContent = "Status: Disconnected";
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    log("Ready");
  </script>
</body>
</html>